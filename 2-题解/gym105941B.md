---
tags:
  - 题解
  - 概率与期望
aliases:
---
## [gym105941B. 随机栈 II](https://codeforces.com/gym/105941/problem/B)

对每个插入的数加一，将值域变为 $[1,n+1]$。
记 $dp(i,j)$ 表示进行了 $j$ 次弹出操作，且仅弹出 $[1,i]$ 中的数字的概率。
记 $cnt_i(j)$ 表示第 $j$ 次弹出操作前有多少 $i$，$num(j)$ 表示第 $j$ 次弹出操作前插入过多少数字（无论是否弹出），则有


[***AC 代码***](https://codeforces.com/gym/105941/submission/328762768)

```cpp
#include <bits/stdc++.h>
using namespace std;
using ll = long long;

const int MOD = 998244353;
ll add(ll x, ll y) { return (x + y) % MOD; }
ll mul(ll x, ll y) { return x * y % MOD; }

ll qpow(ll a, ll b = MOD - 2)
{
    ll res = 1;
    for (; b; b >>= 1) {
        if (b & 1) { res = mul(res, a); }
        a = mul(a, a);
    }
    return res;
}

void solve()
{
    int n;
    cin >> n;
    vector<int> a(n+1);
    int pop = 0;
    for (int i = 1; i <= n; ++i) {
        cin >> a[i];
        if (a[i] >= 0) {
            ++a[i];
        }
        else {
            ++pop;
        }
    }

    vector<int> num(pop+1);
    for (int i = 1, popcnt = 0, sum = 0; i <= n; ++i) {
        if (a[i] == -1) {
            num[++popcnt] = sum;
        }
        else {
            ++sum;
        }
    }

    vector dp(n+2, vector<ll>(pop+1));
    dp[0][0] = 1;

    for (int i = 1; i <= n + 1; ++i) {
        vector<ll> cnt(pop+1);
        for (int j = 1, popcnt = 0, sum = 0; j <= n; ++j) {
            if (a[j] == i) {
                ++sum;
            }
            else if (a[j] == -1) { 
                cnt[++popcnt] = sum;
            }
        }

        for (int j = 1; j <= pop; ++j) {
            ll res = dp[i-1][j-1];
            for (int k = j; k <= pop; ++k) {
                if (cnt[k] < k - j + 1) {
                    break;
                }
                ll cur = cnt[k] - (k - j);
                ll tot = num[k] - k + 1;
                res = mul(res, cur);
                res = mul(res, qpow(tot));
                dp[i][k] = add(dp[i][k], res);
            }
        }

        for (int j = 0; j <= pop; ++j) {
            dp[i][j] = add(dp[i][j], dp[i-1][j]);
        }
    }

    cout << dp[n+1][pop] << "\n";
}

int main()
{
    cin.tie(nullptr)->sync_with_stdio(false);
    int t = 1;
    cin >> t;
    while (t--) { solve(); }
}
```
